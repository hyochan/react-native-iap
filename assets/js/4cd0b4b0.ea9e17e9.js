"use strict";(self.webpackChunkreact_native_iap_docs=self.webpackChunkreact_native_iap_docs||[]).push([[7280],{1437:(e,n,i)=>{i.d(n,{A:()=>c});var s=i(6540),r=i(7856),t=i(4848);function c({children:e,className:n,style:i}){const c=(0,s.useCallback)(()=>{fetch(r.I,{method:"POST",mode:"no-cors"}).catch(()=>{})},[]);return(0,t.jsx)("a",{href:r.V,target:"_blank",rel:"noopener noreferrer",onClick:c,className:n,style:i,children:e})}},5159:(e,n,i)=>{i.d(n,{A:()=>a});var s=i(6540),r=i(6025),t=i(7856),c=i(4848);function a({className:e="iapkit-banner",style:n}){const i=(0,r.Ay)("/img/iapkit-banner.gif"),a=(0,s.useCallback)(e=>{fetch(t.I,{method:"POST",mode:"no-cors"}).catch(()=>{})},[]);return(0,c.jsx)("div",{className:e,style:{marginTop:0,marginBottom:12,textAlign:"center",...n},children:(0,c.jsx)("a",{href:t.V,target:"_blank",rel:"noopener noreferrer",onClick:a,style:{display:"inline-block",textDecoration:"none"},children:(0,c.jsx)("img",{src:i,alt:"IapKit - In-App Purchase Validation Service",style:{border:"none",display:"block"}})})})}},5931:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>h});const s=JSON.parse('{"id":"examples/subscription-flow","title":"Subscriptions Flow Example","description":"The complete working example can be found at example/screens/SubscriptionFlow.tsx.","source":"@site/docs/examples/subscription-flow.md","sourceDirName":"examples","slug":"/examples/subscription-flow","permalink":"/react-native-iap/docs/examples/subscription-flow","draft":false,"unlisted":false,"editUrl":"https://github.com/hyochan/react-native-iap/tree/main/docs/docs/examples/subscription-flow.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"title":"Subscriptions Flow Example","sidebar_label":"Subscriptions Flow","sidebar_position":2},"sidebar":"tutorialSidebar","previous":{"title":"Purchase Flow","permalink":"/react-native-iap/docs/examples/purchase-flow"},"next":{"title":"Available Purchases","permalink":"/react-native-iap/docs/examples/available-purchases"}}');var r=i(4848),t=i(8453),c=i(5159),a=i(1437);const o={title:"Subscriptions Flow Example",sidebar_label:"Subscriptions Flow",sidebar_position:2},l="Subscriptions Flow",d={},h=[{value:"Flow Overview",id:"flow-overview",level:2},{value:"Quick Start with useIAP",id:"quick-start-with-useiap",level:2},{value:"Checking Active Subscriptions",id:"checking-active-subscriptions",level:2},{value:"Plan Changes (Upgrade/Downgrade)",id:"plan-changes-upgradedowngrade",level:2},{value:"iOS",id:"ios",level:3},{value:"Android",id:"android",level:3},{value:"Android Replacement Modes",id:"android-replacement-modes",level:2},{value:"IAPKit Server Verification",id:"iapkit-server-verification",level:2},{value:"Setup",id:"setup",level:3},{value:"Complete Verification Flow",id:"complete-verification-flow",level:3},{value:"IAPKit Purchase States",id:"iapkit-purchase-states",level:3},{value:"Checking Subscription Status on App Launch",id:"checking-subscription-status-on-app-launch",level:3},{value:"Testing",id:"testing",level:3},{value:"Key Points",id:"key-points",level:2},{value:"Resources",id:"resources",level:2}];function p(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"subscriptions-flow",children:"Subscriptions Flow"})}),"\n",(0,r.jsx)(c.A,{}),"\n",(0,r.jsx)(n.admonition,{type:"tip",children:(0,r.jsxs)(n.p,{children:["The complete working example can be found at ",(0,r.jsx)(n.a,{href:"https://github.com/hyochan/react-native-iap/blob/main/example/screens/SubscriptionFlow.tsx",children:"example/screens/SubscriptionFlow.tsx"}),"."]})}),"\n",(0,r.jsx)(n.h2,{id:"flow-overview",children:"Flow Overview"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-txt",children:"Connect \u2192 Fetch Subscriptions \u2192 Request Purchase \u2192 Validate \u2192 Finish Transaction\n"})}),"\n",(0,r.jsx)(n.h2,{id:"quick-start-with-useiap",children:"Quick Start with useIAP"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-tsx",children:"const {subscriptions, fetchProducts, requestPurchase, finishTransaction} =\n  useIAP({\n    onPurchaseSuccess: async (purchase) => {\n      // Validate on your server, then finish\n      await finishTransaction({purchase});\n    },\n    onPurchaseError: (error) => {\n      if (error.code !== ErrorCode.UserCancelled) {\n        Alert.alert('Error', error.message);\n      }\n    },\n  });\n\n// Load subscriptions\nawait fetchProducts({skus: ['premium_monthly'], type: 'subs'});\n\n// Purchase (platform-specific)\nconst subscription = subscriptions[0];\nawait requestPurchase({\n  request: {\n    apple: {sku: 'premium_monthly'},\n    google: {\n      skus: ['premium_monthly'],\n      subscriptionOffers:\n        subscription.subscriptionOfferDetailsAndroid?.map((offer) => ({\n          sku: subscription.id,\n          offerToken: offer.offerToken,\n        })) || [],\n    },\n  },\n  type: 'subs',\n});\n"})}),"\n",(0,r.jsx)(n.h2,{id:"checking-active-subscriptions",children:"Checking Active Subscriptions"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-tsx",children:"const {getActiveSubscriptions, hasActiveSubscriptions} = useIAP();\n\n// Quick check\nconst isActive = await hasActiveSubscriptions(['premium_monthly']);\n\n// Get details\nconst activeList = await getActiveSubscriptions();\n"})}),"\n",(0,r.jsx)(n.h2,{id:"plan-changes-upgradedowngrade",children:"Plan Changes (Upgrade/Downgrade)"}),"\n",(0,r.jsx)(n.h3,{id:"ios",children:"iOS"}),"\n",(0,r.jsx)(n.p,{children:"Subscriptions in the same group auto-replace each other. Just purchase the new plan."}),"\n",(0,r.jsx)(n.h3,{id:"android",children:"Android"}),"\n",(0,r.jsx)(n.p,{children:"Requires explicit replacement with the current purchase token:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-tsx",children:"await requestPurchase({\n  request: {\n    google: {\n      skus: ['premium_yearly'],\n      subscriptionOffers: [...],\n      purchaseToken: currentPurchase.purchaseToken, // Required\n      replacementMode: 1, // WITH_TIME_PRORATION\n    },\n  },\n  type: 'subs',\n});\n"})}),"\n",(0,r.jsx)(n.h2,{id:"android-replacement-modes",children:"Android Replacement Modes"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Value"}),(0,r.jsx)(n.th,{children:"Mode"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"1"})}),(0,r.jsx)(n.td,{children:"WITH_TIME_PRORATION"}),(0,r.jsx)(n.td,{children:"Immediate with prorated credit"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"2"})}),(0,r.jsx)(n.td,{children:"CHARGE_PRORATED_PRICE"}),(0,r.jsx)(n.td,{children:"Immediate with prorated charge"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"6"})}),(0,r.jsx)(n.td,{children:"DEFERRED"}),(0,r.jsx)(n.td,{children:"Change at next renewal"})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"iapkit-server-verification",children:"IAPKit Server Verification"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(a.A,{children:"IAPKit"})," provides server-side subscription verification without your own infrastructure. Get started at ",(0,r.jsx)(n.strong,{children:(0,r.jsx)(a.A,{children:"iapkit.com"})}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"setup",children:"Setup"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Get your API key from ",(0,r.jsx)(a.A,{children:"IAPKit Dashboard"})]}),"\n",(0,r.jsxs)(n.li,{children:["Add environment variable:","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"EXPO_PUBLIC_IAPKIT_API_KEY=your_api_key_here\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"complete-verification-flow",children:"Complete Verification Flow"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-tsx",children:"import {useIAP, verifyPurchaseWithProvider, ErrorCode} from 'react-native-iap';\nimport {Platform, Alert} from 'react-native';\n\nfunction SubscriptionScreen() {\n  const {\n    connected,\n    subscriptions,\n    fetchProducts,\n    requestPurchase,\n    finishTransaction,\n  } = useIAP({\n    onPurchaseSuccess: async (purchase) => {\n      // Step 1: Verify purchase with IAPKit\n      try {\n        const result = await verifyPurchaseWithProvider({\n          provider: 'iapkit',\n          iapkit: {\n            apiKey: process.env.EXPO_PUBLIC_IAPKIT_API_KEY!,\n            apple:\n              Platform.OS === 'ios'\n                ? {jws: purchase.purchaseToken!}\n                : undefined,\n            google:\n              Platform.OS === 'android'\n                ? {purchaseToken: purchase.purchaseToken!}\n                : undefined,\n          },\n        });\n\n        // Step 2: Check verification result\n        if (result.iapkit?.isValid && result.iapkit?.state === 'entitled') {\n          // Step 3: Grant access to user\n          await grantPremiumAccess(purchase.productId);\n\n          // Step 4: Finish transaction\n          await finishTransaction({purchase, isConsumable: false});\n\n          Alert.alert('Success', 'Subscription activated!');\n        } else {\n          console.warn('Verification failed:', result.iapkit?.state);\n          Alert.alert('Error', 'Could not verify purchase');\n        }\n      } catch (error) {\n        console.error('Verification error:', error);\n        // Still finish transaction to avoid stuck state\n        await finishTransaction({purchase, isConsumable: false});\n      }\n    },\n    onPurchaseError: (error) => {\n      if (error.code !== ErrorCode.UserCancelled) {\n        Alert.alert('Purchase Failed', error.message);\n      }\n    },\n  });\n\n  // ... rest of component\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"iapkit-purchase-states",children:"IAPKit Purchase States"}),"\n",(0,r.jsxs)(n.p,{children:["After verification, check the ",(0,r.jsx)(n.code,{children:"state"})," field to determine the subscription status:"]}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"State"}),(0,r.jsx)(n.th,{children:"Action"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"entitled"})}),(0,r.jsx)(n.td,{children:"Grant access - subscription is active"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"expired"})}),(0,r.jsx)(n.td,{children:"Revoke access - subscription has expired"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"canceled"})}),(0,r.jsx)(n.td,{children:"User or store canceled the subscription"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"pending"})}),(0,r.jsx)(n.td,{children:"Payment is pending"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"pending-acknowledgment"})}),(0,r.jsx)(n.td,{children:"Needs acknowledgment (Android)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"inauthentic"})}),(0,r.jsx)(n.td,{children:"Verification failed - may be fraudulent"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"checking-subscription-status-on-app-launch",children:"Checking Subscription Status on App Launch"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-tsx",children:"import {getAvailablePurchases, verifyPurchaseWithProvider} from 'react-native-iap';\nimport {Platform} from 'react-native';\n\nasync function checkSubscriptionOnLaunch(subscriptionId: string) {\n  // Step 1: Get purchases from store\n  const purchases = await getAvailablePurchases([subscriptionId]);\n  const purchase = purchases.find(p => p.productId === subscriptionId);\n\n  if (!purchase) {\n    return {isActive: false, state: 'expired'};\n  }\n\n  // Step 2: Verify with IAPKit for authoritative status\n  const result = await verifyPurchaseWithProvider({\n    provider: 'iapkit',\n    iapkit: {\n      apiKey: process.env.EXPO_PUBLIC_IAPKIT_API_KEY!,\n      apple: Platform.OS === 'ios' ? {jws: purchase.purchaseToken!} : undefined,\n      google: Platform.OS === 'android' ? {purchaseToken: purchase.purchaseToken!} : undefined,\n    },\n  });\n\n  return {\n    isActive: result.iapkit?.state === 'entitled',\n    state: result.iapkit?.state,\n    isValid: result.iapkit?.isValid,\n  };\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"testing",children:"Testing"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.a,{href:"https://github.com/hyochan/react-native-iap/blob/main/example/screens/SubscriptionFlow.tsx",children:"example app"})," has built-in IAPKit support. Set your API key and test subscription verification."]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["For more details about IAPKit verification, see the ",(0,r.jsx)(n.a,{href:"https://www.openiap.dev/docs/apis#iapkit-purchase-states",children:"OpenIAP IAPKit documentation"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"key-points",children:"Key Points"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"iOS"}),": Use subscription groups for automatic plan management"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Android"}),": Must include ",(0,r.jsx)(n.code,{children:"subscriptionOffers"})," and ",(0,r.jsx)(n.code,{children:"purchaseToken"})," for upgrades"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Validation"}),": Always validate receipts on your server before granting access"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Hook callbacks"}),": Use ",(0,r.jsx)(n.code,{children:"onPurchaseSuccess"})," instead of promise chaining"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"resources",children:"Resources"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/hyochan/react-native-iap/blob/main/example/screens/SubscriptionFlow.tsx",children:"Complete example"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://developer.apple.com/app-store/subscriptions/",children:"iOS Subscription Groups"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://developer.android.com/google/play/billing/subscriptions#upgrade-downgrade",children:"Android Subscription Changes"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(p,{...e})}):p(e)}},7856:(e,n,i)=>{i.d(n,{I:()=>r,V:()=>s});const s="https://iapkit.com",r="https://www.hyo.dev/api/ad-banner/cmjf0l2460003249hfyh029dm"},8453:(e,n,i)=>{i.d(n,{R:()=>c,x:()=>a});var s=i(6540);const r={},t=s.createContext(r);function c(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);